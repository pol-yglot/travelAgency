<!DOCTYPE html>
<html lang="ko">
<th:block th:replace="~{/layout/head :: headFragment}"></th:block>
<body>
<header th:replace="~{layout/header :: headerFragment}"></header>
<nav th:replace="~{layout/nav :: navFragment}"></nav>
<main class="main-content">
    <link href="/css/contact.css" rel="stylesheet">

    <div style="height: 30px; display: flex; justify-content: flex-end">
        <a href="javascript:window.history.back()">ë’¤ë¡œê°€ê¸°â†©ï¸</a>
    </div>
    <div class="container">

        <aside th:replace="~{layout/side-bar :: sideBarFragment}"></aside>

    <section class="content">
            <!--<h2 th:text="${'âœˆ '+title +' ì „ì²´ë³´ê¸°'}"></h2>-->
            <h2>ğŸ” ê¶ê¸ˆí•œ ì ì€ ê²€ìƒ‰ìœ¼ë¡œ ì‰½ê³  ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”.</h2>
            <div class="search-bar">
                <form id="searchForm">
                    <select name="searchType" id="searchType" required>
                        <option value="">êµ¬ë¶„</option>
                        <option value="title" th:selected="${searchType == 'title'}">ì œëª©</option>
                        <option value="content" th:selected="${searchType == 'content'}">ë‚´ìš©</option>
                        <option value="userId" th:selected="${searchType == 'userId'}">ì•„ì´ë””</option>
                    </select>
                    <input type="text" id="keyword" name="keyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." onkeyup="enterkey(event);" required>
                    <button type="submit">ê²€ìƒ‰</button>
                </form>
            </div>
            <div class="keywords">
                <a href="#">í‚¤ì›Œë“œ 1</a>
                <a href="#">í‚¤ì›Œë“œ 2</a>
                <a href="#">í‚¤ì›Œë“œ 3</a>
                <a href="#">í‚¤ì›Œë“œ 4</a>
                <a href="#">í‚¤ì›Œë“œ 5</a>
                <a href="#">í‚¤ì›Œë“œ 6</a>
            </div>
            <div class="notice" style="font-size: large; background-color: aliceblue; padding: 10px;">
                <a><strong>ğŸš¨ê³µì§€ </strong> [ì•ˆë‚´] ì‚¬ì´íŠ¸ ì ê²€ ì•ˆë‚´ 4/1</a>
            </div>
            <div class="sort">
                <form method="get" action="/board/boardList">
                    <input type="hidden" name="sortType" id="sortTypeInput">
                    <button class="pretty-button" type="button" onclick="submitSort('recommend')">ì¶”ì²œìˆœ</button>
                    <button class="pretty-button" type="button" onclick="submitSort('popular')">ì¸ê¸°ìˆœ</button>
                    <button class="pretty-button" type="button" onclick="submitSort('comment')">ëŒ“ê¸€ìˆœ</button>
                    <button class="pretty-button" type="button" onclick="submitSort('recent')">ìµœì‹ ìˆœ</button>
                </form>
            </div>
            <div class="quick-register">
                <a href="/board/writeBoard" class="btn-register">+ ì§ˆë¬¸ ë“±ë¡í•˜ê¸°</a> <!-- ì¶”ê°€ -->
            </div>
            <table id="readResults" th:if="${pageInfo != null and pageInfo.items != null and not #lists.isEmpty(pageInfo.items)}">
                <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ì œëª©</th>
                    <th>ë‚´ìš©</th>
                    <th>ì‘ì„±ì</th>
                    <th>ì¡°íšŒìˆ˜</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="board, stat : ${pageInfo.items}" style="text-align: center;">
                    <!--<td name="stat" th:text="${stat.index + 1}"></td>-->
                    <td th:text="${startIndex + stat.index + 1}"></td> <!-- ì—­ìˆœ -->
                    <td><a href="board/boardDetail" th:href="@{/board/boardDetail(BOARD_ID=${board.BOARD_ID})}"><span th:text="${board.BOARD_TITLE}"></span></a></td>
                    <td th:text="${board.BOARD_CONTENT}"></td>
                    <td th:text="${#strings.isEmpty(board.USER_ACCOUNT) ? 'ê²ŒìŠ¤íŠ¸' : board.USER_ACCOUNT}"></td>
                    <td th:text="${board.BOARD_HITS}"></td>
                </tr>
                </tbody>
            </table>

            <div id="searchResults"></div>
            <p th:if="${#lists.isEmpty(pageInfo.items)}" class="no-data">ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>

            <div class="pagination" th:if="${pageInfo.totalPages > 0}">
                <a th:if="${pageInfo.currentPage > 1}" th:href="@{/board/boardList(page=${pageInfo.currentPage - 1})}">&laquo;</a>

                <th:block th:each="page : ${#numbers.sequence(1, pageInfo.totalPages)}">
                    <span th:if="${page == pageInfo.currentPage}" class="current" th:text="${page}"></span>
                    <a th:unless="${page == pageInfo.currentPage}" th:href="@{/board/boardList(page=${page})}" th:text="${page}"></a>
                </th:block>

                <a th:if="${pageInfo.currentPage < pageInfo.totalPages}" th:href="@{/board/boardList(page=${pageInfo.currentPage + 1})}">&raquo;</a>
            </div>
    </section>
    </div>
</main>
<footer th:replace="~{layout/footer :: footerFragment}"></footer>
<script>
    $(function () {
        hashTag();

        // ì¡°íšŒìˆ˜ í˜ì´ì§€ ë¦¬ë¡œë“œ
        window.onpageshow = function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        };

        // í‚¤ì›Œë“œ ê²€ìƒ‰ì²˜ë¦¬
        $('.keywords').find('a').click(function (e) {
            var tag = e.target.textContent;
            var txt = tag.replace('#','');
            $('.search-bar').find('input').val(txt);
        });

        // í•´ì‹œíƒœê·¸ # ì¶”ê°€
        function hashTag() {
            for(var i=0;i<$('.keywords').find('a').length;i++){
                var keywordTxt = $('.keywords').find('a')[i].text;
                $('.keywords').find('a')[i].text = '#'+keywordTxt;
            }
        }

        // 1) ì‹¤ì œ ê²€ìƒ‰ & í˜ì´ì§• ìˆ˜í–‰ í•¨ìˆ˜
        function doSearch(page) {
            var searchType = $('#searchType').val();
            var keyword    = $('#keyword').val().trim();

            console.log("page ===> "+page);

            if(searchType == '' || keyword == ''){
                alert('ê²€ìƒ‰êµ¬ë¶„ í˜¹ì€ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            $.ajax({
                url: '/board/boardList',
                method: 'GET',
                dataType: 'json',
                data: { page: page, searchType: searchType, keyword: keyword },
                success: function(pageInfo) {
                    console.log("pageInfo"+pageInfo);
                    $('#readResults tbody').empty();
                    $('.pagination').hide();
                    renderTable(pageInfo.items, pageInfo.pageSize, pageInfo.totalItems, pageInfo.currentPage);
                    if(pageInfo.totalItems > 0){
                        renderPagination(pageInfo.currentPage, pageInfo.totalPages);
                    }
                },
                error: function() {
                    alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // 2) í…Œì´ë¸” ë°”ë”” ë Œë”ë§
        function renderTable(items, pageSize, totalItems, currentPage) {
            var startIndex = (currentPage-1)*pageSize;
            var html = '';

            if (totalItems > 0){
                $.each(items, function(i, board){
                    var useraccount = board.user_ACCOUNT ? board.user_ACCOUNT : 'ê²ŒìŠ¤íŠ¸';
                    html += '<tr style="text-align: center">';
                    html +=   '<td>' + (startIndex + i + 1) + '</td>';
                    html +=   '<td><a href="/board/boardDetail?BOARD_ID='
                        + board.board_ID + '">' + board.board_TITLE + '</a></td>';
                    html +=   '<td>' + board.board_CONTENT + '</td>';
                    html +=   '<td>' + useraccount + '</td>';
                    html +=   '<td>' + board.board_HITS + '</td>';
                    html += '</tr>';
                });
            }else{
                html += '<tr style="text-align: center">';
                html +=   '<td colspan="5">' + 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤,' + '</td>';
                html += '</tr>';
            }

            $('#readResults tbody').html(html);
        }

        // 3) í˜ì´ì§• ë²„íŠ¼ ë Œë”ë§
        function renderPagination(currentPage, totalPages) {
            debugger;

            var html = '';
            if(totalPages > 0){
                $('.pagination').children().remove();
                $('.pagination').show();

                if (currentPage > 1) {
                    html += '<button class="page-btn" data-page="'+(currentPage-1)+'">&laquo;</button>';
                }
                for (var p=1; p<=totalPages; p++) {
                    if (p === currentPage) {
                        html += '<span class="current">'+p+'</span>';
                    } else {
                        html += '<button class="page-btn" data-page="'+p+'">'+p+'</button>';
                    }
                }
                if (currentPage < totalPages) {
                    html += '<button class="page-btn" data-page="'+(currentPage+1)+'">&raquo;</button>';
                }
            }

            $('.pagination').html(html);
        }

        // 4) ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $('#searchForm').on('submit', function(e){
            e.preventDefault();
            doSearch(1);
        });

        $('.pagination').on('click', '.page-btn', function(){
            var page = $(this).data('page');
            doSearch(page);
        });
    });

    // ì—”í„°í‚¤ê°€ ëˆŒë ¸ì„ ë•Œ ì‹¤í–‰í•˜ëŠ” ë°˜ì‘
    function enterkey(event) {
        if(searchType == '' || keyword == ''){
            alert('ê²€ìƒ‰êµ¬ë¶„ í˜¹ì€ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        if (e.key === 'Enter' || e.keyCode === 13 || e.which === 13) {
            $("#searchForm").submit();
        }
    }

    // ì •ë ¬
    function submitSort(type) {
        $('#sortTypeInput').val(type);
        $('.sort form').submit();
    }
</script>
</body>
</html>