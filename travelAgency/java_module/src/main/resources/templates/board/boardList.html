<!DOCTYPE html>
<html lang="ko">
<th:block th:replace="/layout/head :: headFragment"></th:block>
<body>
<header th:replace="~{layout/header :: headerFragment}"></header>
<nav th:replace="~{layout/nav :: navFragment}"></nav>
<main class="main-content">
    <link href="/css/contact.css" rel="stylesheet">

    <div style="height: 30px; display: flex; justify-content: flex-end">
        <a href="javascript:window.history.back()">뒤로가기↩️</a>
    </div>
    <div class="container">
        <aside class="left-nav">
            <div class="nav-section">
                <h3>카테고리</h3>
                <div style="border-bottom: 3px solid black;"></div>
                <ul>
                    <li><a th:href="@{/board/contact}">자주 묻는 질문 (FAQ)</a></li>
                    <li><a th:href="@{/board/boardList}">질문 전체 조회</a></li>
                </ul>
            </div>
            <div class="nav-section">
                <h3>빠른 링크</h3>
                <div style="border-bottom: 3px solid black;"></div>
                <ul>
                    <li><a href="#">질문 등록하기</a></li>
                    <li><a th:href="@{/board/boardList(searchType=userId)}">내 질문 내역 보기</a></li>
                </ul>
            </div>
        </aside>

    <section class="content">
            <!--<h2 th:text="${'✈ '+title +' 전체보기'}"></h2>-->
            <h2>궁금한 점은 검색으로 쉽고 빠르게 확인하세요.</h2>
            <div class="search-bar">
                <form id="searchForm">
                    <select name="searchType" id="searchType" required>
                        <option value="">구분</option>
                        <option value="title">제목</option>
                        <option value="content">내용</option>
                    </select>
                    <input type="text" id="keyword" name="keyword" placeholder="검색어를 입력하세요." onkeyup="enterkey(e);" required>
                    <button type="submit">검색</button>
                </form>
            </div>
            <div class="keywords">
                <a href="#">키워드 1</a>
                <a href="#">키워드 2</a>
                <a href="#">키워드 3</a>
                <a href="#">키워드 4</a>
                <a href="#">키워드 5</a>
                <a href="#">키워드 6</a>
            </div>
            <div class="notice" style="font-size: large; background-color: aliceblue; padding: 10px;">
                <a><strong>🚨공지 </strong> [안내] 사이트 점검 안내 4/1</a>
            </div>
            <div class="sort">
                <form method="get" action="/board/boardList">
                    <input type="hidden" name="sortType" id="sortTypeInput">
                    <button class="pretty-button" type="button" onclick="submitSort('recommend')">추천순</button>
                    <button class="pretty-button" type="button" onclick="submitSort('popular')">인기순</button>
                    <button class="pretty-button" type="button" onclick="submitSort('comment')">댓글순</button>
                    <button class="pretty-button" type="button" onclick="submitSort('recent')">최신순</button>
                </form>
            </div>
            <div class="quick-register">
                <a href="/faq/register" class="btn-register">+ 질문 등록하기</a> <!-- 추가 -->
            </div>
            <table id="readResults" th:if="${pageInfo != null and pageInfo.items != null and not #lists.isEmpty(pageInfo.items)}">
                <thead>
                <tr>
                    <th>번호</th>
                    <th>제목</th>
                    <th>내용</th>
                    <th>작성자</th>
                    <th>조회수</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="board, stat : ${pageInfo.items}" style="text-align: center;">
                    <!--<td name="stat" th:text="${stat.index + 1}"></td>-->
                    <td th:text="${startIndex + stat.index + 1}"></td> <!-- 역순 -->
                    <td><a href="board/boardDetail" th:href="@{/board/boardDetail(BOARD_ID=${board.BOARD_ID})}"><span th:text="${board.BOARD_TITLE}"></span></a></td>
                    <td th:text="${board.BOARD_CONTENT}"></td>
                    <td th:text="${#strings.isEmpty(board.USER_NAME) ? '게스트' : board.USER_NAME}"></td>
                    <td th:text="${board.BOARD_HITS}"></td>
                </tr>
                </tbody>
            </table>

            <div id="searchResults"></div>
            <p th:if="${#lists.isEmpty(pageInfo.items)}" class="no-data">등록된 게시글이 없습니다.</p>

            <div class="pagination" th:if="${pageInfo.totalPages > 0}">
                <a th:if="${pageInfo.currentPage > 1}" th:href="@{/board/boardList(page=${pageInfo.currentPage - 1})}">&laquo;</a>

                <th:block th:each="page : ${#numbers.sequence(1, pageInfo.totalPages)}">
                    <span th:if="${page == pageInfo.currentPage}" class="current" th:text="${page}"></span>
                    <a th:unless="${page == pageInfo.currentPage}" th:href="@{/board/boardList(page=${page})}" th:text="${page}"></a>
                </th:block>

                <a th:if="${pageInfo.currentPage < pageInfo.totalPages}" th:href="@{/board/boardList(page=${pageInfo.currentPage + 1})}">&raquo;</a>
            </div>
    </section>
    </div>
</main>
<footer th:replace="~{layout/footer :: footerFragment}"></footer>
<script>
    $(document).ready(function () {
        hashTag();

        window.onpageshow = function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        };

        // 엔터키가 눌렸을 때 실행하는 반응
        function enterkey(e) {
            if(searchType == '' || keyword == ''){
                alert('검색구분 혹은 검색어를 입력하세요.');
                return;
            }
            if (e.key === 'Enter' || e.keyCode === 13 || e.which === 13) {
                $("#searchForm").submit();
            }
        }

        // 키워드 검색처리
        $('.keywords').find('a').click(function (e) {
            var tag = e.target.textContent;
            var txt = tag.replace('#','');
            $('.search-bar').find('input').val(txt);
        });

        $('#boardList').click(function (e) {
            location.replace("/board/boardList");
        });

        // 해시태그 # 추가
        function hashTag() {
            for(var i=0;i<$('.keywords').find('a').length;i++){
                var keywordTxt = $('.keywords').find('a')[i].text;
                $('.keywords').find('a')[i].text = '#'+keywordTxt;
            }
        }

        // 정렬
        function submitSort(type) {
            $('#sortTypeInput').val(type);
            $('.sort form').submit();
        }

        // 엔터키가 눌렸을 때 실행하는 반응
        function enterkey(e) {
            if(searchType == '' || keyword == ''){
                alert('검색구분 혹은 검색어를 입력하세요.');
                return;
            }
            if (e.key === 'Enter' || e.keyCode === 13 || e.which === 13) {
                $("#searchForm").submit();
            }
        }

        $('#searchForm').submit(function(event) {
            event.preventDefault(); // 폼 기본 제출 동작 방지

            var searchType = $('#searchType').val();
            var keyword = $('#keyword').val().trim();

            $.ajax({
                url: '/board/boardList',
                type: 'GET',
                dataType: 'json',
                data: { searchType: searchType, keyword: keyword },
                success: function(data) {
                    var html = '';
                    if (data && data.length > 0) { // data는 배열이므로 length 속성으로 확인
                        $.each(data, function(index, board) { // 배열을 순회
                            html += '<tr>';
                            html += '<td>' + (index + 1) + '</td>';
                            html += '<td>' + board.board_TITLE + '</td>'; // 객체의 속성명 그대로 접근
                            html += '<td>' + board.board_CONTENT + '</td>'; // 객체의 속성명 그대로 접근
                            html += '</tr>';
                        });
                        $('#readResults tbody').empty().append(html);
                        $('#searchResults').empty();
                        $('#keyword').val("");
                    } else {
                        $('#searchResults').html('<p class="no-data">검색 결과가 없습니다.</p>');
                        $('#readResults tbody').empty();
                        $('#keyword').val("");
                    }
                },
                error: function(xhr, status, error) {
                    console.error('검색 요청 실패:', error);
                    alert('검색 에러!');
                    $('#keyword').val("");
                }
            });
        });
    });
</script>
</body>
</html>